---
title: "analysis"
author: "Zakari L. Billo"
output: pdf_document
---

```{r include=false}
library(tidyverse)
library(glmnet)
library(pcalg)
library(foreach)
library(doParallel)
library(reshape2)
library(graph)
library(stats)
library(boot)
```

# Load the clean data 

```{r}
X_filtered <- read_csv("data/X_filtered.csv")
X_filtered <- as.data.frame(X_filtered)

X_asthma <- read_csv("data/X_asthma.csv")
X_asthma <- as.data.frame(X_asthma)

X_normal <- read_csv("data/X_normal.csv")
X_normal <- as.data.frame(X_normal)
```

Run Lasso for the MAP3K5âˆ’AS2 neighborhood and compare lambda seq results against lambda.1se to make a tractable network of the top 25 most stable genes

```{r}
# Setup 
y <- as.numeric(X_filtered[, "MAP3K5-AS2"])
x <- as.matrix(X_filtered[, setdiff(colnames(X_filtered), "MAP3K5-AS2")])

full_fit <- glmnet(x, y, alpha = 1) # Alpha = 1
lambda_seq <- full_fit$lambda 

n_stab_boot <- 10000 
n_cores <- detectCores() - 1
cl <- makeCluster(n_cores)
registerDoParallel(cl)

# Subsampling helper 
run_lasso_sub <- function(x, y, lambdas) {
  sub_idx <- sample(1:nrow(x), floor(nrow(x))/2, replace = FALSE) # Use n/2 subsamples with no replacement for stability test
  fit <- glmnet(x[sub_idx,], y[sub_idx], alpha = 1, lambda = lambdas)
  coefs <- coef(fit, s = lambdas)
  return(as.matrix(coefs[-1, ] != 0) * 1) 
}

# Export lambda_seq to cluster
clusterExport(cl, c("x", "y", "lambda_seq", "run_lasso_sub"))
clusterEvalQ(cl, library(glmnet))

# Bootstrap
message(paste("Running", n_stab_boot, "bootstrap..."))
stab_list <- foreach(i = 1:n_stab_boot) %dopar% {
  run_lasso_sub(x, y, lambda_seq)
}
stopCluster(cl)

# Find stability probabilities 
prob_matrix <- Reduce("+", stab_list) / n_stab_boot
colnames(prob_matrix) <- paste0("L", 1:length(lambda_seq))

# Find the optimal lambda
cv_check <- cv.glmnet(x, y, alpha = 1, lambda = lambda_seq)
target_lambda_idx <- which(lambda_seq == cv_check$lambda.1se)

# Nearest index at the target lambda if exact match fails
if(length(target_lambda_idx) == 0) {
    target_lambda_idx <- which.min(abs(lambda_seq - cv_check$lambda.1se))
}
gene_stability_scores <- prob_matrix[, target_lambda_idx]

# Create and sort df
stability_df <- data.frame(
  Gene = rownames(prob_matrix), # Use rownames from the matrix
  Stability_Prob = as.numeric(gene_stability_scores)
)

stability_df <- stability_df[order(-stability_df$Stability_Prob), ]

# Top 25 genes
top_genes <- head(stability_df$Gene, 25)
final_genes <- unique(c("MAP3K5-AS2", top_genes))
if(length(final_genes) > 25) {
  final_genes <- final_genes[1:25]
}

# Save 
X_asthma_stable <- X_asthma[, final_genes]
write.csv(X_asthma_stable, "data/X_asthma_stable.csv")

X_normal_stable <- X_normal[, final_genes]
write.csv(X_normal_stable, "data/X_normal_stable.csv")

X_filtered_stable <- X_filtered[, final_genes]
write.csv(X_filtered_stable, "data/X_filtered_stable.csv")
```

Plot PAGs of top 25 genes with FCI

```{r}
analyze_pag_sensitivity_fci <- function(data, title = NULL, file_name = NULL) {
  
  # Filename setup
  data_arg_name <- deparse(substitute(data)) 
  
  if (is.null(file_name)) {
    clean_title <- gsub("[^[:alnum:]]", "_", title)
    file_name <- paste0(clean_title, ".pdf")
  }
  
  # Define alphas
  alphas <- c(0.01, 0.05, 0.10)
  
  # Initialize results df
  results_df <- data.frame(Alpha = numeric(), 
                            Edge_Count = integer(), 
                            Time_Sec = numeric())
  
  # suffStat
  suffStat <- list(C = cor(data, use = "pairwise.complete.obs"), n = nrow(data))
  
  pdf(file_name, width = 10, height = 10)
  
  for (alpha in alphas) {
    
    message(paste("FCI on Alpha:", alpha, "..."))
    
    # system.time
    pag.est <- NULL
    
    timer <- system.time({
      pag.est <- fci(suffStat, indepTest = gaussCItest, alpha = alpha, 
                     labels = colnames(data), verbose = FALSE, m.max = 4)
    })
    
    # Extract elapsed time
    duration <- timer["elapsed"]
    
    # Count Edges
    amat <- pag.est@amat
    current_edges <- sum(amat[upper.tri(amat)] != 0)
    
    # Store Results
    results_df <- rbind(results_df, data.frame(Alpha = alpha, 
                                                 Edge_Count = current_edges, 
                                                 Time_Sec = as.numeric(duration)))
    
    # Plot PAG
    plot(pag.est)
    
    # Title
    title_text <- paste0(title, 
                         "\nalpha: ", alpha, 
                         "   edges: ", current_edges, 
                         "   time: ", round(duration, 3), "s")
    
    title(main = title_text, col.main = "blue", cex.main = 1.5)
  }
  
  dev.off()
  
  return(results_df)
}

results_asthma <- analyze_pag_sensitivity_fci(X_asthma_stable,
                                          file_name = "fci_Asthma_PAG_Analysis.pdf")

results_normal <- analyze_pag_sensitivity_fci(X_normal_stable,
                                          file_name = "fci_Normal_PAG_Analysis.pdf")

results_filtered <- analyze_pag_sensitivity_fci(X_filtered_stable,
                                          file_name = "fci_Filtered_PAG_Analysis.pdf")

print(results_asthma)
print(results_normal)
print(results_filtered)

# Visualize runtime
plot(results_asthma$Alpha, results_asthma$Time_Sec, 
     type = "b", pch = 19, col = "red",
     main = "Computation Time by Alpha",
     xlab = "Alpha", ylab = "Time (seconds)")

plot(results_normal$Alpha, results_normal$Time_Sec, 
     type = "b", pch = 19, col = "red",
     main = "Computation Time by Alpha",
     xlab = "Alpha", ylab = "Time (seconds)")

plot(results_filtered$Alpha, results_filtered$Time_Sec, 
     type = "b", pch = 19, col = "red",
     main = "Computation Time by Alpha",
     xlab = "Alpha", ylab = "Time (seconds)")
```

Plot PAGs of top 25 genes with RFCI

```{r}
analyze_pag_sensitivity_rfci <- function(data, title = NULL, file_name = NULL) {
  
  # Filename setup
  data_arg_name <- deparse(substitute(data)) 
  
  if (is.null(file_name)) {
    clean_title <- gsub("[^[:alnum:]]", "_", title)
    file_name <- paste0(clean_title, ".pdf")
  }
  
  # Define alphas
  alphas <- c(0.01, 0.05, 0.10)
  
  # Initialize results df
  results_df <- data.frame(Alpha = numeric(), 
                            Edge_Count = integer(), 
                            Time_Sec = numeric())
  
  # suffStat
  suffStat <- list(C = cor(data, use = "pairwise.complete.obs"), n = nrow(data))
  
  pdf(file_name, width = 10, height = 10)
  
  for (alpha in alphas) {
    
    message(paste("RFCI on Alpha:", alpha, "..."))
    
    # system.time
    pag.est <- NULL
    
    timer <- system.time({
      pag.est <- rfci(suffStat, indepTest = gaussCItest, alpha = alpha, 
                     labels = colnames(data), verbose = FALSE, m.max = 4)
    })
    
    # Extract elapsed time
    duration <- timer["elapsed"]
    
    # Count Edges
    amat <- pag.est@amat
    current_edges <- sum(amat[upper.tri(amat)] != 0)
    
    # Store Results
    results_df <- rbind(results_df, data.frame(Alpha = alpha, 
                                                 Edge_Count = current_edges, 
                                                 Time_Sec = as.numeric(duration)))
    
    # Plot
    plot(pag.est)
    
    # Title
    title_text <- paste0(title, 
                         "\nalpha: ", alpha, 
                         "   edges: ", current_edges, 
                         "   time: ", round(duration, 3), "s")
    
    title(main = title_text, col.main = "blue", cex.main = 1.5)
  }
  
  dev.off()
  
  return(results_df)
}

# Save

results_asthma <- analyze_pag_sensitivity_rfci(X_asthma_stable,
                                          file_name = "rfci_Asthma_PAG_Analysis.pdf")

results_normal <- analyze_pag_sensitivity_rfci(X_normal_stable,
                                          file_name = "rfci_Normal_PAG_Analysis.pdf")

results_filtered <- analyze_pag_sensitivity_rfci(X_filtered_stable,
                                          file_name = "rfci_Filtered_PAG_Analysis.pdf")

print(results_asthma)
print(results_normal)
print(results_filtered)

# Runtime plot
plot(results_asthma$Alpha, results_asthma$Time_Sec, 
     type = "b", pch = 19, col = "red",
     main = "Computation Time by Alpha",
     xlab = "Alpha", ylab = "Time (seconds)")

plot(results_normal$Alpha, results_normal$Time_Sec, 
     type = "b", pch = 19, col = "red",
     main = "Computation Time by Alpha",
     xlab = "Alpha", ylab = "Time (seconds)")

plot(results_filtered$Alpha, results_filtered$Time_Sec, 
     type = "b", pch = 19, col = "red",
     main = "Computation Time by Alpha",
     xlab = "Alpha", ylab = "Time (seconds)")
```

Compare the edge counts

```{r}
sparsity_data <- data.frame(
  Alpha = rep(c(0.01, 0.05, 0.10), 6),
  Edges = c(33, 42, 51, 28, 37, 41, 21, 26, 32,  # RFCI: Overall, Asthma, Normal
            20, 25, 28, 19, 24, 25, 17, 18, 16), # FCI: Overall, Asthma, Normal
  Group = rep(c("Overall", "Asthma", "Normal", "Overall", "Asthma", "Normal"), each = 3),
  Method = rep(c("RFCI", "FCI"), each = 9)
)

ggplot(sparsity_data, aes(x = Alpha, y = Edges, color = Group, linetype = Method)) +
  geom_line(size = 1) +
  geom_point(size = 3) +
  theme_minimal() +
  labs(title = "Network Sparsity vs. Alpha",
       subtitle = "Comparison of RFCI and FCI across Study Groups",
       x = "Significance Level (Alpha)",
       y = "Number of Edges in PAG") +
  scale_x_continuous(breaks = c(0.01, 0.05, 0.10))

# Save
ggsave("sparsity comparison.png")
```

Go with alpha = 0.01, use LV-IDA and RFCI to see the causal effect of MAP3K5-AS2 on other genes in the full dataset to idendify targets (capture median effect and its CI). Make a function for background scripting

```{r}

```

Compare LV-IDA results between asthma and normal children with Welch's t-test

```{r}
asthma <- read.csv("Results/LV-IDA FX/asthma lvida.csv")
normal <- read.csv("Results/LV-IDA FX/normal lvida.csv")

# Format CI
format_ci <- function(med, lower, upper) {
  sprintf("%.3f (%.3f, %.3f)", med, lower, upper)
}

asthma <- asthma |>
  mutate(Median_Effect_Asthma_Str = format_ci(Median_Effect, CI_Lower, CI_Upper))

normal <- normal |>
  mutate(Median_Effect_Normal_Str = format_ci(Median_Effect, CI_Lower, CI_Upper))

# Merge
merged_df <- inner_join(
  asthma |> select(Target_Gene, Median_Effect, Median_Effect_Asthma_Str),
  normal |> select(Target_Gene, Median_Effect, Median_Effect_Normal_Str),
  by = "Target_Gene",
  suffix = c("_Asthma", "_Normal")
)

# Welch's t-test
t_test_result <- t.test(merged_df$Median_Effect_Asthma, 
                        merged_df$Median_Effect_Normal, 
                        var.equal = FALSE)

p_val <- t_test_result$p.value

merged_df$Global_P_Value <- sprintf("%.3f", p_val)

# Table
final_table <- merged_df |>
  select(Target_Gene, Median_Effect_Asthma_Str, Median_Effect_Normal_Str, Global_P_Value) |>
  rename(
    Median_Effect_Asthma = Median_Effect_Asthma_Str,
    Median_Effect_Normal = Median_Effect_Normal_Str
  )

print(head(final_table))
write.csv(final_table, "asthma_normal_with_pvalue.csv", row.names = FALSE)
```

Try running IDA at alpha = 0.01 to get some results to compare to (turns out this doesn't work; there are no valid CPDAGs produced at each iteration)

```{r}
estimate_downstream_effects_ida_serial <- function(data, cause_var, n_boots = 100, file_name = NULL) {
  
  # Setup
  alpha_val <- 0.01  
  node_names <- colnames(data)
  cause_idx <- which(node_names == cause_var)
  
  if (length(cause_idx) == 0) stop("Cause variable not found in data.")
  
  potential_targets <- node_names[-cause_idx]
  target_indices <- setdiff(seq_along(node_names), cause_idx)
  n_targets <- length(target_indices)
  n_obs <- nrow(data)
  
  # Filenames
  clean_cause <- gsub("[^[:alnum:]]", "_", cause_var)
  csv_name <- if(is.null(file_name)) paste0("IDA_Stability_", clean_cause, ".csv") else file_name
  
  message(paste("Processing", n_boots, "bootstrap..."))
  
  # Boot loop
  boot_results <- vector("list", n_boots)
  pb <- txtProgressBar(min = 0, max = n_boots, style = 3)
  
  for (b in 1:n_boots) {
    boot_indices <- sample.int(n_obs, n_obs, replace = TRUE)
    boot_data <- data[boot_indices, ]
    
    # suffStat
    suffStat <- list(C = cor(boot_data, use = "pairwise.complete.obs"), n = n_obs)
    mcov <- cov(boot_data, use = "pairwise.complete.obs")
    
    # Use PC
    pc_fit <- tryCatch({
      pc(suffStat, indepTest = gaussCItest, alpha = alpha_val, 
         labels = node_names, verbose = FALSE, solve.confl = TRUE)
    }, error = function(e) {
      return(NULL)
    })
    
    if (is.null(pc_fit)) {
      setTxtProgressBar(pb, b)
      next
    }

    # Get effect
    row_eff <- numeric(n_targets)
    
    for (i in seq_along(target_indices)) {
      target_idx <- target_indices[i]
      
      effs <- tryCatch({
        pcalg::ida(cause_idx, target_idx, mcov, pc_fit@graph, method = "local")
      }, error = function(e) {
        return(NA)
      })
      
      # Use median to aggregate
      if (!all(is.na(effs)) && length(effs) > 0) {
        row_eff[i] <- median(effs, na.rm = TRUE)
      }
    }
    
    boot_results[[b]] <- row_eff
    setTxtProgressBar(pb, b)
  }
  
  close(pb)
  
  # Results aggregation
  valid_results <- boot_results[!sapply(boot_results, is.null)]
  n_valid <- length(valid_results)
  message(paste("\nIDA Bootstraps:", n_valid, "/", n_boots))
  
  eff_matrix <- do.call(cbind, valid_results)
  
  compute_stats <- function(row) {
    causal_vals <- row[row != 0]
    if (length(causal_vals) == 0) return(c(0, 0, 0))
    c(median(causal_vals), quantile(causal_vals, 0.025), quantile(causal_vals, 0.975))
  }
  
  stats_data <- t(apply(eff_matrix, 1, compute_stats))
  
  final_summary <- data.frame(
    Target_Gene   = potential_targets,
    Stability_Pct = (rowSums(eff_matrix != 0) / n_valid) * 100,
    Median_Effect = stats_data[, 1],
    CI_Lower      = stats_data[, 2],
    CI_Upper      = stats_data[, 3]
  )
  
  write.csv(final_summary, csv_name, row.names = FALSE)
  return(final_summary)
}

# Run
asthma_results_ida <- estimate_downstream_effects_ida_serial(X_asthma_stable, "MAP3K5-AS2", n_boots = 100, "asthma_ida_results.csv")
```