---
title: "data processing"
author: Zakari Lowenthal Billo (zlb2008)
output: pdf_document
---

```{r include=false}
library(tidyverse)
library(BiocManager)
library(AnnotationDbi)
library(hgu133plus2.db)
library(matrixStats)
```

## Pre-processing (follow the steps of Wang et al.)

This is expression data profiling by array of human lymphoblastoid cell lines derived from 400 children from families recruited through a proband with asthma

```{r}
# Rows: Affymetrix probe sets
# Columns: samples (individuals)
# One non-data row containing the string "RMA Normalized"

expr_raw <- read.table(
  "data/Normalized_expression.txt",
  header = TRUE,
  sep = "\t",
  check.names = FALSE,
  stringsAsFactors = FALSE
)

# Inspect 
str(expr_raw)
dim(expr_raw)
```

Set probe IDs as row names

```{r}
rownames(expr_raw) <- expr_raw[, 1]
expr_raw <- expr_raw[, -1]

# Check 
head(rownames(expr_raw))
```

Remove non-expression descriptor row

```{r}
expr_raw <- expr_raw[-1, ]

# Check 
head(expr_raw[, 1])

# Force to numeric
expr <- as.data.frame(lapply(expr_raw, as.numeric))

rownames(expr) <- rownames(expr_raw)
```

Final check for data validity

```{r}
# 54,675 probes x 395 samples
dim(expr)

# Missing values check
sum(is.na(expr))

# Distribution check (RMA-normalized log2 values)
summary(as.vector(as.matrix(expr)))
```

Remove low-expression probes (biological QC), then do variance-based filtering

```{r}
probe_means <- rowMeans(expr)

# Remove bottom 40% of probes by mean expression (similar to Wang et al.)
mean_cutoff <- quantile(probe_means, 0.40) 
expr_qc <- expr[probe_means > mean_cutoff, ]

dim(expr_qc) # 32805 probes x 395 samples

probe_vars <- apply(expr_qc, 1, var)

# Now take top 1000 most variable probes
top1000 <- names(sort(probe_vars, decreasing = TRUE))[1:1000]
expr_1000 <- expr_qc[top1000, ]
```

Transpose + Scale

```{r}
X_1000 <- t(expr_1000)

dim(X_1000) # 395 x 1000

X_1000_scaled <- scale(X_1000)
```
Now load metadata directly from EBI

```{r}
sdrf_url <- "https://www.ebi.ac.uk/biostudies/files/E-MTAB-1425/E-MTAB-1425.sdrf.txt"
metadata <- read.delim(sdrf_url, stringsAsFactors = FALSE)

# Check the column names to find Sex and Disease
# It is named "Characteristics.sex."
head(metadata)
```

Clean Metadata, then merge with expression data

```{r}
# Fix the expression datarow names
clean_expr_ids <- gsub("^X", "", rownames(X_1000_scaled))
rownames(X_1000_scaled) <- clean_expr_ids

# Clean the Metadata IDs
metadata$clean_id <- as.character(metadata$Source.Name)

# Find the common samples
common_samples <- intersect(rownames(X_1000_scaled), metadata$clean_id)

# Subset and align
X_matched <- X_1000_scaled[common_samples, ]
meta_matched <- metadata[match(common_samples, metadata$clean_id), ]

# Check
all(rownames(X_matched) == meta_matched$clean_id)

# Create vectors for sex and disease status
sex_vec <- factor(meta_matched$Characteristics.sex.)
disease_vec <- factor(meta_matched$Characteristics.disease)
age_vec <- as.numeric(meta_matched$Characteristics.age.)
```

Filter out sex or age-associated genes among the top 1000 expressed

```{r}
# Functions to get p-value (for sex and age association)
get_sex_pval <- function(gene_col) {
  # gene_col (1 gene per col) from X_matched
  summary(lm(gene_col ~ sex_vec))$coefficients[2, 4] 
}

get_age_pval <- function(gene_col) {
  # gene_col (1 gene per col) from X_matched
  summary(lm(gene_col ~ age_vec))$coefficients[2, 4] 
}

# Run regressions
sex_pvals <- apply(X_matched, 2, get_sex_pval)
age_pvals <- apply(X_matched, 2, get_age_pval) 

# Adjust for multiple resting
sex_qvals <- p.adjust(sex_pvals, method = "BH")
age_qvals <- p.adjust(age_pvals, method = "BH")

# Filter by intersection
# Wang et al. (2016) removes genes associated with age or sex
keep_condition <- (sex_qvals > 0.01) & (age_qvals > 0.01)
genes_to_keep <- colnames(X_matched)[keep_condition]
```

For microarray preprocessing, convert probe IDs to gene symbols, choose the highest variance probe for each gene assignment and avoid B cell confounding genes (IGH, IGK, and IGL). I only want protein encoding genes

```{r}
# map probes to symbols based on Entrez ID
probe_annotation <- AnnotationDbi::select(
  hgu133plus2.db,
  keys     = genes_to_keep,
  keytype  = "PROBEID",
  columns  = c("SYMBOL", "ENTREZID", "GENENAME")
)

# Filter for protein encoding only
probe_annotation_clean <- probe_annotation %>%
  filter(!is.na(SYMBOL)) %>%
  filter(!grepl("^LOC|^LINC|P$", SYMBOL)) %>% # Drop predicted, lncRNA, pseudogenes
  filter(!grepl("^IG[HKL]", SYMBOL)) %>%      # Drop immunoglobulins associated with B-cells
  distinct(PROBEID, SYMBOL, .keep_all = TRUE) %>%
  filter(PROBEID %in% colnames(X_matched))

probe_ids <- probe_annotation_clean$PROBEID

# Calc probe variance
probe_variance <- apply(
  X_matched[, probe_ids, drop = FALSE],
  2,
  var
)

# Pick top probe per gene
top_variance_probes <- probe_annotation_clean %>%
  mutate(var = probe_variance[PROBEID]) %>%
  group_by(SYMBOL) %>%
  slice_max(var, n = 1, with_ties = FALSE) %>% # Force unique row per gene
  ungroup()

write_csv(top_variance_probes, "data/top_probe_to_gene_mapping.csv")

# Subset expression matrix
valid_probes <- top_variance_probes$PROBEID
X_filtered <- X_matched[, valid_probes, drop = FALSE] 

# Rename cols to symbols helper
probe_to_gene <- setNames(
  top_variance_probes$SYMBOL,
  top_variance_probes$PROBEID
)

colnames(X_filtered) <- probe_to_gene[colnames(X_filtered)]
colnames(X_filtered) <- make.unique(colnames(X_filtered)) # 642 x 395

write_csv(as.data.frame(X_filtered), "data/X_filtered.csv")

write_csv(data.frame(GENE = colnames(X_filtered)), "data/final_gene_list.csv")
```

Stratify into asthmatics and non-asthmatics

```{r}
# Subsamples
asthma_idx <- which(disease_vec == "asthma")
normal_idx <- which(disease_vec == "normal")

X_asthma <- X_filtered[asthma_idx, ]
X_normal <- X_filtered[normal_idx, ]

write_csv(as.data.frame(X_asthma), "data/X_asthma.csv")
write_csv(as.data.frame(X_normal), "data/X_normal.csv")
```